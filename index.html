<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gen Ed % Calculator</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; max-width: 1200px; }
    h1 { margin: 0 0 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    select, input { width: 100%; padding: 10px; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 10px; text-align: left; vertical-align: middle; }
    th { font-size: 13px; color: #374151; }
    .btns { display: flex; gap: 10px; margin: 12px 0; flex-wrap: wrap; }
    button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; margin-top: 14px; }
    .big { font-size: 36px; font-weight: 800; }
    .muted { color: #6b7280; }
    .warn { background: #fee2e2; border: 1px solid #ef4444; color: #7f1d1d; padding: 12px; border-radius: 12px; margin-top: 12px; font-weight: 800; }
    .ok { background: #ecfeff; border: 1px solid #06b6d4; color: #164e63; padding: 12px; border-radius: 12px; margin-top: 12px; font-weight: 700; }
    .pill { display: inline-block; padding: 3px 10px; border-radius: 999px; font-size: 12px; font-weight: 800; }
    .pill.out { background: #fee2e2; color: #7f1d1d; }
    .pill.in { background: #dcfce7; color: #14532d; }
    .right { text-align: right; }
    .small { font-size: 12px; }
    .hint { font-size: 12px; color: #6b7280; margin-top: 6px; }
  </style>
</head>

<body>
  <h1>Gen Ed Participation % Calculator</h1>
  <div class="muted">Static, client-side calculator (no student identifiers, no storage).</div>

  <div class="card">
    <div class="row">
      <div>
        <label for="school">School</label>
        <select id="school"></select>
        <div class="hint">Select a school to load minute totals.</div>
      </div>
      <div>
        <label for="grade">Grade</label>
        <select id="grade">
          <option value="">Select grade…</option>
          <option value="TK">TK</option>
          <option value="K">K</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
        </select>
        <div class="hint">Grade determines band (Lower/Upper/All).</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Grade Band</label>
        <div id="band" class="muted">—</div>
      </div>
      <div>
        <label>Weekly Instructional Minutes (reference only)</label>
        <div id="weeklyInstr" class="muted">—</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Total School Minutes (NEW overall total)</label>
        <div id="totalSchool" class="muted">—</div>
      </div>
      <div>
        <label>Non-Instructional Minutes (counts as Gen Ed)</label>
        <div id="nonInstr" class="muted">—</div>
      </div>
    </div>

    <div class="btns">
      <button id="addRow">+ Add Service Row</button>
      <button id="clear">Clear</button>
      <button id="copy">Copy Summary</button>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:26%">Service Code</th>
          <th style="width:30%">Location</th>
          <th style="width:10%">In/Out</th>
          <th style="width:10%">Duration</th>
          <th style="width:12%">Frequency</th>
          <th class="right" style="width:12%">Weekly mins</th>
          <th style="width:4%"></th>
        </tr>
      </thead>
      <tbody id="services"></tbody>
    </table>

    <div id="message"></div>

    <div class="card" style="margin-top:16px;">
      <div class="muted">Gen Ed Participation</div>
      <div class="big" id="genEdPct">—</div>
      <div class="muted small" id="breakdown"></div>
    </div>
  </div>

<script>
/** ====== CONFIG DATA (edit here) ====== **/

const serviceCodes = [
  "210-Family training, counseling, and home visits",
  "220-Medical services (for evaluation only)",
  "230-Nutrition Services",
  "240-Service Coordination",
  "250-Special Instruction",
  "260-SpEd aide in reg. development class child care center/family child care home",
  "270-Respite Care services",
  "330-Specialized Academic Instruction",
  "340-Intensive Individual Services",
  "415-Language and Speech",
  "425-Adapted Physical Education",
  "435-Health and nursing-specialized physical health care services",
  "436-Health and nursing - other services",
  "445-Assistive technology services",
  "450-Occupational therapy",
  "460-Physical Therapy",
  "510-Individual counseling",
  "515-Counseling and guidance",
  "520-Parent counseling",
  "525-Social work services",
  "535-Behavior Intervention Services",
  "540-Day treatment services",
  "545-Residential Treatment services",
  "610-Specialized services for low incidence disabilities",
  "710-Specialized deaf and hard of hearing services",
  "715-Interpreter services",
  "720-Audiological services",
  "760-Recreation services, includes therapeutic recreation",
  "820-College Awareness",
  "830-Vocational assessment, counseling, guidance, and career assessment",
  "840-Career awareness",
  "850-Work experience education",
  "855-Job coaching (includes job shadow and service learning)",
  "860-Mentoring",
  "865-Agency linkages (referral and placement)",
  "870-Travel training (includes mobility training)",
  "890-Other transition service",
  "900-Other special education/related services"
];

// Key: `${school}|${band}` band = Lower / Upper / All
// CALC USES: total (overall minutes) and outside service mins only.
const minutesBySchoolBand = {
  "Courreges|Lower": { instr: 1412, nonInstr: 260, total: 1672 },
  "Courreges|Upper": { instr: 1574, nonInstr: 260, total: 1834 },
  "Cox|Lower": { instr: 1412, nonInstr: 235, total: 1647 },
  "Cox|Upper": { instr: 1574, nonInstr: 235, total: 1809 },
  "Fulton|All": { instr: 1595, nonInstr: 254, total: 1849 },
  "Gisler|Lower": { instr: 1412, nonInstr: 260, total: 1672 },
  "Gisler|Upper": { instr: 1574, nonInstr: 215, total: 1789 },
  "Masuda|All": { instr: 1608, nonInstr: 254, total: 1862 },
  "Newland|Lower": { instr: 1440, nonInstr: 215, total: 1655 },
  "Newland|Upper": { instr: 1580, nonInstr: 215, total: 1795 },
  "Oka|Lower": { instr: 1412, nonInstr: 260, total: 1672 },
  "Oka|Upper": { instr: 1574, nonInstr: 260, total: 1834 },
  "Plavan|Lower": { instr: 1413, nonInstr: 260, total: 1673 },
  "Plavan|Upper": { instr: 1575, nonInstr: 260, total: 1835 },
  "Talbert|All": { instr: 1595, nonInstr: 254, total: 1849 },
  "Tamura|Lower": { instr: 1413, nonInstr: 240, total: 1653 },
  "Tamura|Upper": { instr: 1575, nonInstr: 240, total: 1815 },
};

const locationInsideOutside = {
  "205-Home/Community Based (infants/preschool)": "Outside",
  "210-Home": "Outside",
  "220-Hospital": "Outside",
  "330-Public Preschool": "Outside",
  "340-Private Preschool": "Outside",
  "350-Extended Day Care": "Outside",
  "360-Residential Facility": "Outside",
  "510-Regular Classroom/Public Day School": "Inside",
  "520-Separate Classroom in Public Integrated Facility": "Outside",
  "530-State Special School": "Outside",
  "540-Separate School or Special Education Center or Facility": "Outside",
  "550-Public Residential School": "Outside",
  "560-Other Public School or Facility": "Outside",
  "610-Continuation School": "Outside",
  "620-Alternative Work Education Center/Work Study Facility": "Outside",
  "630-Juvenile Court School": "Outside",
  "640-County Community School": "Outside",
  "650-Correctional Institution or Facility": "Outside",
  "710-Community College": "Outside",
  "720-Adult Education Facility": "Outside",
  "810-Nonpublic Day School": "Outside",
  "820-Nonpublic Residential School - in California": "Outside",
  "830-Nonpublic Residential School - outside California": "Outside",
  "840-Private Day School (not certified by Special Education Division)": "Outside",
  "850-Private Residential School (not certified by Special Education Division)": "Outside",
  "860-Parochial School": "Outside",
  "890-Service Provider Location": "Outside",
};

const freqToWeekly = (mins, freq) => {
  const m = Number(mins);
  if (!Number.isFinite(m) || m < 0) return 0;
  switch (freq) {
    case "Daily": return m * 5;
    case "Weekly": return m;
    case "Monthly": return m / 4;
    case "Yearly": return m / 36;
    default: return 0;
  }
};

/** ====== UI / LOGIC ====== **/

const elSchool = document.getElementById("school");
const elGrade = document.getElementById("grade");
const elBand = document.getElementById("band");
const elWeeklyInstr = document.getElementById("weeklyInstr"); // reference only
const elTotalSchool = document.getElementById("totalSchool");
const elNonInstr = document.getElementById("nonInstr");
const elServices = document.getElementById("services");
const elMsg = document.getElementById("message");
const elPct = document.getElementById("genEdPct");
const elBreakdown = document.getElementById("breakdown");

const btnAddRow = document.getElementById("addRow");
const btnClear = document.getElementById("clear");
const btnCopy = document.getElementById("copy");

const uniqueSchools = [...new Set(Object.keys(minutesBySchoolBand).map(k => k.split("|")[0]))].sort();

// Add blank "Select school..." option first
const blankSchool = document.createElement("option");
blankSchool.value = "";
blankSchool.textContent = "Select school…";
elSchool.appendChild(blankSchool);

// Then add actual schools
for (const s of uniqueSchools) {
  const opt = document.createElement("option");
  opt.value = s; opt.textContent = s;
  elSchool.appendChild(opt);
}

const locationOptions = Object.keys(locationInsideOutside);
const serviceOptions = serviceCodes;

function gradeToBand(g) {
  if (!g) return "";
  if (g === "TK" || g === "K") return "Lower";
  const n = Number(g);
  if (Number.isFinite(n)) {
    if (n <= 2) return "Lower";
    if (n <= 5) return "Upper";
    return "All";
  }
  return "";
}

function getMinutes() {
  const school = elSchool.value;
  const grade = elGrade.value;
  if (!school || !grade) return null;
  const band = gradeToBand(grade);
  if (!band) return null;
  return minutesBySchoolBand[`${school}|${band}`] ?? null;
}

function addServiceRow(initial = {}) {
  const tr = document.createElement("tr");

  // Service Code select
  const tdSvc = document.createElement("td");
  const selSvc = document.createElement("select");
  const blankSvc = document.createElement("option");
  blankSvc.value = "";
  blankSvc.textContent = "Select service…";
  selSvc.appendChild(blankSvc);
  for (const code of serviceOptions) {
    const opt = document.createElement("option");
    opt.value = code; opt.textContent = code;
    selSvc.appendChild(opt);
  }
  selSvc.value = initial.service ?? "";
  tdSvc.appendChild(selSvc);

  // Location select
  const tdLoc = document.createElement("td");
  const selLoc = document.createElement("select");
  const blankLoc = document.createElement("option");
  blankLoc.value = "";
  blankLoc.textContent = "Select location…";
  selLoc.appendChild(blankLoc);
  for (const loc of locationOptions) {
    const opt = document.createElement("option");
    opt.value = loc; opt.textContent = loc;
    selLoc.appendChild(opt);
  }
  selLoc.value = initial.location ?? "";
  tdLoc.appendChild(selLoc);

  // Inside/Outside pill
  const tdIO = document.createElement("td");
  const io = document.createElement("span");
  io.className = "pill";
  tdIO.appendChild(io);

  // Duration input
  const tdDur = document.createElement("td");
  const inpDur = document.createElement("input");
  inpDur.type = "number";
  inpDur.min = "0";
  inpDur.step = "1";
  inpDur.placeholder = "0";
  inpDur.value = initial.duration ?? "";
  tdDur.appendChild(inpDur);

  // Frequency select
  const tdFreq = document.createElement("td");
  const selFreq = document.createElement("select");
  ["Weekly","Daily","Monthly","Yearly"].forEach(v => {
    const opt = document.createElement("option");
    opt.value = v; opt.textContent = v;
    selFreq.appendChild(opt);
  });
  selFreq.value = initial.freq ?? "Weekly";
  tdFreq.appendChild(selFreq);

  // Weekly minutes calc
  const tdWk = document.createElement("td");
  tdWk.className = "right";
  tdWk.textContent = "0";

  // Remove button
  const tdRm = document.createElement("td");
  const btnRm = document.createElement("button");
  btnRm.textContent = "✕";
  btnRm.title = "Remove row";
  tdRm.appendChild(btnRm);

  tr.append(tdSvc, tdLoc, tdIO, tdDur, tdFreq, tdWk, tdRm);
  elServices.appendChild(tr);

  const updateRow = () => {
    const loc = selLoc.value;
    const status = loc ? (locationInsideOutside[loc] ?? "") : "";
    io.textContent = status || "—";
    io.classList.toggle("out", status === "Outside");
    io.classList.toggle("in", status === "Inside");
    io.classList.toggle("pill", true);

    const wk = freqToWeekly(inpDur.value, selFreq.value);
    tdWk.textContent = wk ? wk.toFixed(2).replace(/\.00$/,"") : "0";
    recalc();
  };

  selLoc.addEventListener("change", updateRow);
  inpDur.addEventListener("input", updateRow);
  selFreq.addEventListener("change", updateRow);
  selSvc.addEventListener("change", recalc);

  btnRm.addEventListener("click", () => { tr.remove(); recalc(); });

  updateRow();
}

function setButtonsEnabled(enabled) {
  btnAddRow.disabled = !enabled;
  btnCopy.disabled = !enabled;
}

function recalc() {
  const grade = elGrade.value;
  const band = gradeToBand(grade);
  elBand.textContent = band || "—";

  const mins = getMinutes();
  const weeklyInstr = mins?.instr ?? null;   // reference only
  const nonInstr = mins?.nonInstr ?? null;
  const totalSchool = mins?.total ?? null;   // NEW denominator

  elWeeklyInstr.textContent = (weeklyInstr == null) ? "—" : weeklyInstr;
  elNonInstr.textContent = (nonInstr == null) ? "—" : nonInstr;
  elTotalSchool.textContent = (totalSchool == null) ? "—" : totalSchool;

  const schoolReady = Boolean(elSchool.value);
  const gradeReady = Boolean(elGrade.value);
  const ready = schoolReady && gradeReady && totalSchool != null;

  setButtonsEnabled(true);

  // Sum totals
  let totalWeekly = 0;
  let outsideWeekly = 0;

  [...elServices.querySelectorAll("tr")].forEach(tr => {
    const selects = tr.querySelectorAll("select");
    const selLoc = selects[1];
    const loc = selLoc?.value ?? "";
    const status = loc ? (locationInsideOutside[loc] ?? "") : "";
    const dur = tr.querySelector('input[type="number"]')?.value ?? "";
    const freq = selects[2]?.value ?? "Weekly";
    const wk = freqToWeekly(dur, freq);

    totalWeekly += wk;
    if (status === "Outside") outsideWeekly += wk;
  });

// Messages (VALIDATION)
// Services happen only during instructional time, so they must fit within weeklyInstr.
// Gen Ed % still uses totalSchool as the denominator.
elMsg.innerHTML = "";

if (ready && weeklyInstr != null && totalWeekly > weeklyInstr) {
  const div = document.createElement("div");
  div.className = "warn";
  div.textContent =
    "WARNING: TOTAL SERVICE MINUTES EXCEED WEEKLY INSTRUCTIONAL MINUTES! " +
    "Services must occur during instructional time.";
  elMsg.appendChild(div);
} else if (ready && weeklyInstr != null && outsideWeekly > weeklyInstr) {
  const div = document.createElement("div");
  div.className = "warn";
  div.textContent =
    "WARNING: OUTSIDE SERVICE MINUTES EXCEED WEEKLY INSTRUCTIONAL MINUTES!";
  elMsg.appendChild(div);
} else if (ready && (totalWeekly > 0 || outsideWeekly > 0)) {
  const div = document.createElement("div");
  div.className = "ok";
  div.textContent = "Totals look valid.";
  elMsg.appendChild(div);
}

  

  // Gen Ed %
  if (!ready || totalSchool === 0) {
    elPct.textContent = "—";
    elBreakdown.textContent = (!schoolReady || !gradeReady)
      ? "Select a school and grade to calculate Gen Ed %."
      : "";
    return;
  }

  // *** CRITICAL: denominator is TOTAL SCHOOL minutes ***
  const genEd = Math.max(0, Math.min(1, 1 - (outsideWeekly / totalSchool)));
  const genEdMinutes = Math.max(0, totalSchool - outsideWeekly);

  elPct.textContent = (genEd * 100).toFixed(2) + "%";
  elBreakdown.textContent =
  `Outside weekly mins: ${outsideWeekly.toFixed(2).replace(/\.00$/,"")} • ` +
  `Total weekly service mins: ${totalWeekly.toFixed(2).replace(/\.00$/,"")} • ` +
  `Weekly instructional mins (service cap): ${weeklyInstr ?? "—"} • ` +
  `Total school mins (Gen Ed % denominator): ${totalSchool} • ` +
  `Non-instructional (counts as Gen Ed): ${nonInstr}`;

btnAddRow.addEventListener("click", () => addServiceRow());

btnClear.addEventListener("click", () => {
  elSchool.value = "";
  elGrade.value = "";
  elServices.innerHTML = "";
  addServiceRow();
  addServiceRow();
  recalc();
});

btnCopy.addEventListener("click", async () => {
  const school = elSchool.value || "(not selected)";
  const grade = elGrade.value || "(not selected)";
  const band = gradeToBand(elGrade.value) || "(not selected)";

  const mins = getMinutes();
  const weeklyInstr = mins?.instr ?? null;
  const nonInstr = mins?.nonInstr ?? null;
  const totalSchool = mins?.total ?? null;

  const pct = elPct.textContent;

  const lines = [];
  [...elServices.querySelectorAll("tr")].forEach((tr, idx) => {
    const selects = tr.querySelectorAll("select");
    const svc = selects[0]?.value ?? "";
    const loc = selects[1]?.value ?? "";
    const status = loc ? (locationInsideOutside[loc] ?? "") : "";
    const dur = tr.querySelector('input[type="number"]')?.value ?? "";
    const freq = selects[2]?.value ?? "Weekly";
    const wk = tr.querySelector("td.right")?.textContent ?? "0";
    if (svc || loc || dur) lines.push(`${idx+1}. ${svc || "(no service)"} | ${loc || "(no location)"} (${status || "—"}) — ${dur || 0} mins, ${freq} → ${wk} weekly`);
  });

  const text =
`Gen Ed % Calculator Summary
School: ${school}
Grade: ${grade} (Band: ${band})

Total School Minutes (overall): ${totalSchool ?? "—"}
Non-Instructional Minutes (counts as Gen Ed): ${nonInstr ?? "—"}
Weekly Instructional Minutes (reference only): ${weeklyInstr ?? "—"}

Gen Ed %: ${pct}

Services:
${lines.length ? lines.join("\n") : "(none)"}\n`;

  try {
    await navigator.clipboard.writeText(text);
    alert("Copied summary to clipboard.");
  } catch {
    prompt("Copy this summary:", text);
  }
});

elSchool.addEventListener("change", recalc);
elGrade.addEventListener("change", recalc);

// init
elSchool.value = "";
elGrade.value = "";
addServiceRow();
addServiceRow();
recalc();
</script>
</body>
</html>
